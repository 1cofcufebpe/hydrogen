"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const jmp_1 = require("@aminya/jmp");
const uuid_1 = require("uuid");
const spawnteract_1 = require("spawnteract");
const config_1 = __importDefault(require("./config"));
const kernel_transport_1 = __importDefault(require("./kernel-transport"));
const utils_1 = require("./utils");
class ZMQKernel extends kernel_transport_1.default {
    constructor(kernelSpec, grammar, options, onStarted) {
        super(kernelSpec, grammar);
        this.executionCallbacks = {};
        this.options = options || {};
        options.cleanupConnectionFile = false;
        spawnteract_1.launchSpec(kernelSpec, options).then(({ config, connectionFile, spawn }) => {
            this.connection = config;
            this.connectionFile = connectionFile;
            this.kernelProcess = spawn;
            this.monitorNotifications(spawn);
            this.connect(() => {
                this._executeStartupCode();
                if (onStarted) {
                    onStarted(this);
                }
            });
        });
    }
    connect(done) {
        const scheme = this.connection.signature_scheme.slice("hmac-".length);
        const { key } = this.connection;
        this.shellSocket = new jmp_1.Socket("dealer", scheme, key);
        this.stdinSocket = new jmp_1.Socket("dealer", scheme, key);
        this.ioSocket = new jmp_1.Socket("sub", scheme, key);
        const id = uuid_1.v4();
        this.shellSocket.identity = `dealer${id}`;
        this.stdinSocket.identity = `dealer${id}`;
        this.ioSocket.identity = `sub${id}`;
        const address = `${this.connection.transport}://${this.connection.ip}:`;
        this.shellSocket.connect(address + this.connection.shell_port);
        this.ioSocket.connect(address + this.connection.iopub_port);
        this.ioSocket.subscribe("");
        this.stdinSocket.connect(address + this.connection.stdin_port);
        this.shellSocket.on("message", this.onShellMessage.bind(this));
        this.ioSocket.on("message", this.onIOMessage.bind(this));
        this.stdinSocket.on("message", this.onStdinMessage.bind(this));
        this.monitor(done);
    }
    monitorNotifications(childProcess) {
        childProcess.stdout.on("data", (data) => {
            data = data.toString();
            if (atom.config.get("Hydrogen.kernelNotifications")) {
                atom.notifications.addInfo(this.kernelSpec.display_name, {
                    description: data,
                    dismissable: true,
                });
            }
            else {
                utils_1.log("ZMQKernel: stdout:", data);
            }
        });
        childProcess.stderr.on("data", (data) => {
            atom.notifications.addError(this.kernelSpec.display_name, {
                description: data.toString(),
                dismissable: true,
            });
        });
    }
    monitor(done) {
        try {
            const socketNames = ["shellSocket", "ioSocket"];
            let waitGroup = socketNames.length;
            const onConnect = ({ socketName, socket }) => {
                utils_1.log(`ZMQKernel: ${socketName} connected`);
                socket.unmonitor();
                waitGroup--;
                if (waitGroup === 0) {
                    utils_1.log("ZMQKernel: all main sockets connected");
                    this.setExecutionState("idle");
                    if (done) {
                        done();
                    }
                }
            };
            const monitor = (socketName, socket) => {
                utils_1.log(`ZMQKernel: monitor ${socketName}`);
                socket.on("connect", onConnect.bind(this, {
                    socketName,
                    socket,
                }));
                socket.monitor();
            };
            monitor("shellSocket", this.shellSocket);
            monitor("ioSocket", this.ioSocket);
        }
        catch (err) {
            utils_1.log("ZMQKernel:", err);
        }
    }
    interrupt() {
        if (process.platform === "win32") {
            atom.notifications.addWarning("Cannot interrupt this kernel", {
                detail: "Kernel interruption is currently not supported in Windows.",
            });
        }
        else {
            utils_1.log("ZMQKernel: sending SIGINT");
            this.kernelProcess.kill("SIGINT");
        }
    }
    _kill() {
        utils_1.log("ZMQKernel: sending SIGKILL");
        this.kernelProcess.kill("SIGKILL");
    }
    _executeStartupCode() {
        const displayName = this.kernelSpec.display_name;
        let startupCode = config_1.default.getJson("startupCode")[displayName];
        if (startupCode) {
            utils_1.log("KernelManager: Executing startup code:", startupCode);
            startupCode += "\n";
            this.execute(startupCode, (message, channel) => { });
        }
    }
    shutdown() {
        this._socketShutdown();
    }
    restart(onRestarted) {
        this._socketRestart(onRestarted);
    }
    _socketShutdown(restart = false) {
        const requestId = `shutdown_${uuid_1.v4()}`;
        const message = _createMessage("shutdown_request", requestId);
        message.content = {
            restart,
        };
        this.shellSocket.send(new jmp_1.Message(message));
    }
    _socketRestart(onRestarted) {
        if (this.executionState === "restarting") {
            return;
        }
        this.setExecutionState("restarting");
        this._socketShutdown(true);
        this._kill();
        const { spawn } = spawnteract_1.launchSpecFromConnectionInfo(this.kernelSpec, this.connection, this.connectionFile, this.options);
        this.kernelProcess = spawn;
        this.monitor(() => {
            this._executeStartupCode();
            if (onRestarted) {
                onRestarted();
            }
        });
    }
    execute(code, onResults) {
        utils_1.log("ZMQKernel.execute:", code);
        const requestId = `execute_${uuid_1.v4()}`;
        const message = _createMessage("execute_request", requestId);
        message.content = {
            code,
            silent: false,
            store_history: true,
            user_expressions: {},
            allow_stdin: true,
        };
        this.executionCallbacks[requestId] = onResults;
        this.shellSocket.send(new jmp_1.Message(message));
    }
    complete(code, onResults) {
        utils_1.log("ZMQKernel.complete:", code);
        const requestId = `complete_${uuid_1.v4()}`;
        const message = _createMessage("complete_request", requestId);
        message.content = {
            code,
            text: code,
            line: code,
            cursor_pos: utils_1.js_idx_to_char_idx(code.length, code),
        };
        this.executionCallbacks[requestId] = onResults;
        this.shellSocket.send(new jmp_1.Message(message));
    }
    inspect(code, cursorPos, onResults) {
        utils_1.log("ZMQKernel.inspect:", code, cursorPos);
        const requestId = `inspect_${uuid_1.v4()}`;
        const message = _createMessage("inspect_request", requestId);
        message.content = {
            code,
            cursor_pos: cursorPos,
            detail_level: 0,
        };
        this.executionCallbacks[requestId] = onResults;
        this.shellSocket.send(new jmp_1.Message(message));
    }
    inputReply(input) {
        const requestId = `input_reply_${uuid_1.v4()}`;
        const message = _createMessage("input_reply", requestId);
        message.content = {
            value: input,
        };
        this.stdinSocket.send(new jmp_1.Message(message));
    }
    onShellMessage(message) {
        utils_1.log("shell message:", message);
        if (!_isValidMessage(message)) {
            return;
        }
        const { msg_id } = message.parent_header;
        let callback;
        if (msg_id) {
            callback = this.executionCallbacks[msg_id];
        }
        if (callback) {
            callback(message, "shell");
        }
    }
    onStdinMessage(message) {
        utils_1.log("stdin message:", message);
        if (!_isValidMessage(message)) {
            return;
        }
        const { msg_id } = message.parent_header;
        let callback;
        if (msg_id) {
            callback = this.executionCallbacks[msg_id];
        }
        if (callback) {
            callback(message, "stdin");
        }
    }
    onIOMessage(message) {
        utils_1.log("IO message:", message);
        if (!_isValidMessage(message)) {
            return;
        }
        const { msg_type } = message.header;
        if (msg_type === "status") {
            const status = message.content.execution_state;
            this.setExecutionState(status);
        }
        const { msg_id } = message.parent_header;
        let callback;
        if (msg_id) {
            callback = this.executionCallbacks[msg_id];
        }
        if (callback) {
            callback(message, "iopub");
        }
    }
    destroy() {
        utils_1.log("ZMQKernel: destroy:", this);
        this.shutdown();
        this._kill();
        fs_1.default.unlinkSync(this.connectionFile);
        this.shellSocket.close();
        this.ioSocket.close();
        this.stdinSocket.close();
        super.destroy();
    }
}
exports.default = ZMQKernel;
function _isValidMessage(message) {
    if (!message) {
        utils_1.log("Invalid message: null");
        return false;
    }
    if (!message.content) {
        utils_1.log("Invalid message: Missing content");
        return false;
    }
    if (message.content.execution_state === "starting") {
        utils_1.log("Dropped starting status IO message");
        return false;
    }
    if (!message.parent_header) {
        utils_1.log("Invalid message: Missing parent_header");
        return false;
    }
    if (!message.parent_header.msg_id) {
        utils_1.log("Invalid message: Missing parent_header.msg_id");
        return false;
    }
    if (!message.parent_header.msg_type) {
        utils_1.log("Invalid message: Missing parent_header.msg_type");
        return false;
    }
    if (!message.header) {
        utils_1.log("Invalid message: Missing header");
        return false;
    }
    if (!message.header.msg_id) {
        utils_1.log("Invalid message: Missing header.msg_id");
        return false;
    }
    if (!message.header.msg_type) {
        utils_1.log("Invalid message: Missing header.msg_type");
        return false;
    }
    return true;
}
function _getUsername() {
    return (process.env.LOGNAME ||
        process.env.USER ||
        process.env.LNAME ||
        process.env.USERNAME);
}
function _createMessage(msgType, msgId = uuid_1.v4()) {
    const message = {
        header: {
            username: _getUsername(),
            session: "00000000-0000-0000-0000-000000000000",
            msg_type: msgType,
            msg_id: msgId,
            date: new Date(),
            version: "5.0",
        },
        metadata: {},
        parent_header: {},
        content: {},
    };
    return message;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiem1xLWtlcm5lbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi96bXEta2VybmVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUEsNENBQW9CO0FBQ3BCLHFDQUE4QztBQUM5QywrQkFBMEI7QUFDMUIsNkNBQXVFO0FBQ3ZFLHNEQUE4QjtBQUM5QiwwRUFBaUQ7QUFFakQsbUNBQWtEO0FBZWxELE1BQXFCLFNBQVUsU0FBUSwwQkFBZTtJQVVwRCxZQUNFLFVBQThCLEVBQzlCLE9BQWdCLEVBQ2hCLE9BQTRCLEVBQzVCLFNBQTREO1FBRTVELEtBQUssQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFmN0IsdUJBQWtCLEdBQXdCLEVBQUUsQ0FBQztRQWdCM0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLElBQUksRUFBRSxDQUFDO1FBRTdCLE9BQU8sQ0FBQyxxQkFBcUIsR0FBRyxLQUFLLENBQUM7UUFDdEMsd0JBQVUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUNsQyxDQUFDLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFO1lBQ3BDLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO1lBQzNCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRTtnQkFDaEIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7Z0JBRTNCLElBQUksU0FBUyxFQUFFO29CQUNiLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDakI7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUF1RDtRQUM3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dCB7IEdyYW1tYXIgfSBmcm9tIFwiYXRvbVwiO1xyXG5pbXBvcnQgeyBDaGlsZFByb2Nlc3MgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xyXG5pbXBvcnQgZnMgZnJvbSBcImZzXCI7XHJcbmltcG9ydCB7IE1lc3NhZ2UsIFNvY2tldCB9IGZyb20gXCJAYW1pbnlhL2ptcFwiO1xyXG5pbXBvcnQgeyB2NCB9IGZyb20gXCJ1dWlkXCI7XHJcbmltcG9ydCB7IGxhdW5jaFNwZWMsIGxhdW5jaFNwZWNGcm9tQ29ubmVjdGlvbkluZm8gfSBmcm9tIFwic3Bhd250ZXJhY3RcIjtcclxuaW1wb3J0IENvbmZpZyBmcm9tIFwiLi9jb25maWdcIjtcclxuaW1wb3J0IEtlcm5lbFRyYW5zcG9ydCBmcm9tIFwiLi9rZXJuZWwtdHJhbnNwb3J0XCI7XHJcbmltcG9ydCB0eXBlIHsgUmVzdWx0c0NhbGxiYWNrIH0gZnJvbSBcIi4va2VybmVsLXRyYW5zcG9ydFwiO1xyXG5pbXBvcnQgeyBsb2csIGpzX2lkeF90b19jaGFyX2lkeCB9IGZyb20gXCIuL3V0aWxzXCI7XHJcbmltcG9ydCB0eXBlIHsgS2VybmVsc3BlY01ldGFkYXRhIH0gZnJvbSBcIkBudGVyYWN0L3R5cGVzXCI7XHJcblxyXG5leHBvcnQgdHlwZSBDb25uZWN0aW9uID0ge1xyXG4gIGNvbnRyb2xfcG9ydDogbnVtYmVyO1xyXG4gIGhiX3BvcnQ6IG51bWJlcjtcclxuICBpb3B1Yl9wb3J0OiBudW1iZXI7XHJcbiAgaXA6IHN0cmluZztcclxuICBrZXk6IHN0cmluZztcclxuICBzaGVsbF9wb3J0OiBudW1iZXI7XHJcbiAgc2lnbmF0dXJlX3NjaGVtZTogc3RyaW5nO1xyXG4gIHN0ZGluX3BvcnQ6IG51bWJlcjtcclxuICB0cmFuc3BvcnQ6IHN0cmluZztcclxuICB2ZXJzaW9uOiBudW1iZXI7XHJcbn07XHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFpNUUtlcm5lbCBleHRlbmRzIEtlcm5lbFRyYW5zcG9ydCB7XHJcbiAgZXhlY3V0aW9uQ2FsbGJhY2tzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XHJcbiAgY29ubmVjdGlvbjogQ29ubmVjdGlvbjtcclxuICBjb25uZWN0aW9uRmlsZTogc3RyaW5nO1xyXG4gIGtlcm5lbFByb2Nlc3M6IENoaWxkUHJvY2VzcztcclxuICBvcHRpb25zOiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xyXG4gIHNoZWxsU29ja2V0OiBTb2NrZXQ7XHJcbiAgc3RkaW5Tb2NrZXQ6IFNvY2tldDtcclxuICBpb1NvY2tldDogU29ja2V0O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIGtlcm5lbFNwZWM6IEtlcm5lbHNwZWNNZXRhZGF0YSxcclxuICAgIGdyYW1tYXI6IEdyYW1tYXIsXHJcbiAgICBvcHRpb25zOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxyXG4gICAgb25TdGFydGVkOiAoKC4uLmFyZ3M6IEFycmF5PGFueT4pID0+IGFueSkgfCBudWxsIHwgdW5kZWZpbmVkXHJcbiAgKSB7XHJcbiAgICBzdXBlcihrZXJuZWxTcGVjLCBncmFtbWFyKTtcclxuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307XHJcbiAgICAvLyBPdGhlcndpc2Ugc3Bhd250ZXJhY3QgZGVsZXRlcyB0aGUgZmlsZSBhbmQgaHlkcm9nZW4ncyByZXN0YXJ0IGtlcm5lbCBmYWlsc1xyXG4gICAgb3B0aW9ucy5jbGVhbnVwQ29ubmVjdGlvbkZpbGUgPSBmYWxzZTtcclxuICAgIGxhdW5jaFNwZWMoa2VybmVsU3BlYywgb3B0aW9ucykudGhlbihcclxuICAgICAgKHsgY29uZmlnLCBjb25uZWN0aW9uRmlsZSwgc3Bhd24gfSkgPT4ge1xyXG4gICAgICAgIHRoaXMuY29ubmVjdGlvbiA9IGNvbmZpZztcclxuICAgICAgICB0aGlzLmNvbm5lY3Rpb25GaWxlID0gY29ubmVjdGlvbkZpbGU7XHJcbiAgICAgICAgdGhpcy5rZXJuZWxQcm9jZXNzID0gc3Bhd247XHJcbiAgICAgICAgdGhpcy5tb25pdG9yTm90aWZpY2F0aW9ucyhzcGF3bik7XHJcbiAgICAgICAgdGhpcy5jb25uZWN0KCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGFydHVwQ29kZSgpO1xyXG5cclxuICAgICAgICAgIGlmIChvblN0YXJ0ZWQpIHtcclxuICAgICAgICAgICAgb25TdGFydGVkKHRoaXMpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgY29ubmVjdChkb25lOiAoKC4uLmFyZ3M6IEFycmF5PGFueT4pID0+IGFueSkgfCBudWxsIHwgdW5kZWZpbmVkKSB7XHJcbiAgICBjb25zdCBzY2hlbWUgPSB0aGlzLmNvbm5lY3Rpb24uc2lnbmF0dXJlX3NjaGVtZS5zbGljZShcImhtYWMtXCIubGVuZ3RoKTtcclxuICAgIGNvbnN0IHsga2V5IH0gPSB0aGlzLmNvbm5lY3Rpb247XHJcbiAgICB0aGlzLnNoZWxsU29ja2V0ID0gbmV3IFNvY2tldChcImRlYWxlclwiLCBzY2hlbWUsIGtleSk7XHJcbiAgICB0aGlzLnN0ZGluU29ja2V0ID0gbmV3IFNvY2tldChcImRlYWxlclwiLCBzY2hlbWUsIGtleSk7XHJcbiAgICB0aGlzLmlvU29ja2V0ID0gbmV3IFNvY2tldChcInN1YlwiLCBzY2hlbWUsIGtleSk7XHJcbiAgICBjb25zdCBpZCA9IHY0KCk7XHJcbiAgICB0aGlzLnNoZWxsU29ja2V0LmlkZW50aXR5ID0gYGRlYWxlciR7aWR9YDtcclxuICAgIHRoaXMuc3RkaW5Tb2NrZXQuaWRlbnRpdHkgPSBgZGVhbGVyJHtpZH1gO1xyXG4gICAgdGhpcy5pb1NvY2tldC5pZGVudGl0eSA9IGBzdWIke2lkfWA7XHJcbiAgICBjb25zdCBhZGRyZXNzID0gYCR7dGhpcy5jb25uZWN0aW9uLnRyYW5zcG9ydH06Ly8ke3RoaXMuY29ubmVjdGlvbi5pcH06YDtcclxuICAgIHRoaXMuc2hlbGxTb2NrZXQuY29ubmVjdChhZGRyZXNzICsgdGhpcy5jb25uZWN0aW9uLnNoZWxsX3BvcnQpO1xyXG4gICAgdGhpcy5pb1NvY2tldC5jb25uZWN0KGFkZHJlc3MgKyB0aGlzLmNvbm5lY3Rpb24uaW9wdWJfcG9ydCk7XHJcbiAgICB0aGlzLmlvU29ja2V0LnN1YnNjcmliZShcIlwiKTtcclxuICAgIHRoaXMuc3RkaW5Tb2NrZXQuY29ubmVjdChhZGRyZXNzICsgdGhpcy5jb25uZWN0aW9uLnN0ZGluX3BvcnQpO1xyXG4gICAgdGhpcy5zaGVsbFNvY2tldC5vbihcIm1lc3NhZ2VcIiwgdGhpcy5vblNoZWxsTWVzc2FnZS5iaW5kKHRoaXMpKTtcclxuICAgIHRoaXMuaW9Tb2NrZXQub24oXCJtZXNzYWdlXCIsIHRoaXMub25JT01lc3NhZ2UuYmluZCh0aGlzKSk7XHJcbiAgICB0aGlzLnN0ZGluU29ja2V0Lm9uKFwibWVzc2FnZVwiLCB0aGlzLm9uU3RkaW5NZXNzYWdlLmJpbmQodGhpcykpO1xyXG4gICAgdGhpcy5tb25pdG9yKGRvbmUpO1xyXG4gIH1cclxuXHJcbiAgbW9uaXRvck5vdGlmaWNhdGlvbnMoY2hpbGRQcm9jZXNzOiBDaGlsZFByb2Nlc3MpIHtcclxuICAgIGNoaWxkUHJvY2Vzcy5zdGRvdXQub24oXCJkYXRhXCIsIChkYXRhOiBzdHJpbmcgfCBCdWZmZXIpID0+IHtcclxuICAgICAgZGF0YSA9IGRhdGEudG9TdHJpbmcoKTtcclxuXHJcbiAgICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoXCJIeWRyb2dlbi5rZXJuZWxOb3RpZmljYXRpb25zXCIpKSB7XHJcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8odGhpcy5rZXJuZWxTcGVjLmRpc3BsYXlfbmFtZSwge1xyXG4gICAgICAgICAgZGVzY3JpcHRpb246IGRhdGEsXHJcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsb2coXCJaTVFLZXJuZWw6IHN0ZG91dDpcIiwgZGF0YSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgY2hpbGRQcm9jZXNzLnN0ZGVyci5vbihcImRhdGFcIiwgKGRhdGE6IHN0cmluZyB8IEJ1ZmZlcikgPT4ge1xyXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IodGhpcy5rZXJuZWxTcGVjLmRpc3BsYXlfbmFtZSwge1xyXG4gICAgICAgIGRlc2NyaXB0aW9uOiBkYXRhLnRvU3RyaW5nKCksXHJcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBtb25pdG9yKGRvbmU6ICgoLi4uYXJnczogQXJyYXk8YW55PikgPT4gYW55KSB8IG51bGwgfCB1bmRlZmluZWQpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHNvY2tldE5hbWVzID0gW1wic2hlbGxTb2NrZXRcIiwgXCJpb1NvY2tldFwiXTtcclxuICAgICAgbGV0IHdhaXRHcm91cCA9IHNvY2tldE5hbWVzLmxlbmd0aDtcclxuXHJcbiAgICAgIGNvbnN0IG9uQ29ubmVjdCA9ICh7IHNvY2tldE5hbWUsIHNvY2tldCB9KSA9PiB7XHJcbiAgICAgICAgbG9nKGBaTVFLZXJuZWw6ICR7c29ja2V0TmFtZX0gY29ubmVjdGVkYCk7XHJcbiAgICAgICAgc29ja2V0LnVubW9uaXRvcigpO1xyXG4gICAgICAgIHdhaXRHcm91cC0tO1xyXG5cclxuICAgICAgICBpZiAod2FpdEdyb3VwID09PSAwKSB7XHJcbiAgICAgICAgICBsb2coXCJaTVFLZXJuZWw6IGFsbCBtYWluIHNvY2tldHMgY29ubmVjdGVkXCIpO1xyXG4gICAgICAgICAgdGhpcy5zZXRFeGVjdXRpb25TdGF0ZShcImlkbGVcIik7XHJcbiAgICAgICAgICBpZiAoZG9uZSkge1xyXG4gICAgICAgICAgICBkb25lKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgbW9uaXRvciA9IChzb2NrZXROYW1lLCBzb2NrZXQpID0+IHtcclxuICAgICAgICBsb2coYFpNUUtlcm5lbDogbW9uaXRvciAke3NvY2tldE5hbWV9YCk7XHJcbiAgICAgICAgc29ja2V0Lm9uKFxyXG4gICAgICAgICAgXCJjb25uZWN0XCIsXHJcbiAgICAgICAgICBvbkNvbm5lY3QuYmluZCh0aGlzLCB7XHJcbiAgICAgICAgICAgIHNvY2tldE5hbWUsXHJcbiAgICAgICAgICAgIHNvY2tldCxcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgICBzb2NrZXQubW9uaXRvcigpO1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgbW9uaXRvcihcInNoZWxsU29ja2V0XCIsIHRoaXMuc2hlbGxTb2NrZXQpO1xyXG4gICAgICBtb25pdG9yKFwiaW9Tb2NrZXRcIiwgdGhpcy5pb1NvY2tldCk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgbG9nKFwiWk1RS2VybmVsOlwiLCBlcnIpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaW50ZXJydXB0KCkge1xyXG4gICAgaWYgKHByb2Nlc3MucGxhdGZvcm0gPT09IFwid2luMzJcIikge1xyXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyhcIkNhbm5vdCBpbnRlcnJ1cHQgdGhpcyBrZXJuZWxcIiwge1xyXG4gICAgICAgIGRldGFpbDogXCJLZXJuZWwgaW50ZXJydXB0aW9uIGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIGluIFdpbmRvd3MuXCIsXHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbG9nKFwiWk1RS2VybmVsOiBzZW5kaW5nIFNJR0lOVFwiKTtcclxuICAgICAgdGhpcy5rZXJuZWxQcm9jZXNzLmtpbGwoXCJTSUdJTlRcIik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfa2lsbCgpIHtcclxuICAgIGxvZyhcIlpNUUtlcm5lbDogc2VuZGluZyBTSUdLSUxMXCIpO1xyXG4gICAgdGhpcy5rZXJuZWxQcm9jZXNzLmtpbGwoXCJTSUdLSUxMXCIpO1xyXG4gIH1cclxuXHJcbiAgX2V4ZWN1dGVTdGFydHVwQ29kZSgpIHtcclxuICAgIGNvbnN0IGRpc3BsYXlOYW1lID0gdGhpcy5rZXJuZWxTcGVjLmRpc3BsYXlfbmFtZTtcclxuICAgIGxldCBzdGFydHVwQ29kZSA9IENvbmZpZy5nZXRKc29uKFwic3RhcnR1cENvZGVcIilbZGlzcGxheU5hbWVdO1xyXG5cclxuICAgIGlmIChzdGFydHVwQ29kZSkge1xyXG4gICAgICBsb2coXCJLZXJuZWxNYW5hZ2VyOiBFeGVjdXRpbmcgc3RhcnR1cCBjb2RlOlwiLCBzdGFydHVwQ29kZSk7XHJcbiAgICAgIHN0YXJ0dXBDb2RlICs9IFwiXFxuXCI7XHJcbiAgICAgIHRoaXMuZXhlY3V0ZShzdGFydHVwQ29kZSwgKG1lc3NhZ2UsIGNoYW5uZWwpID0+IHt9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNodXRkb3duKCkge1xyXG4gICAgdGhpcy5fc29ja2V0U2h1dGRvd24oKTtcclxuICB9XHJcblxyXG4gIHJlc3RhcnQob25SZXN0YXJ0ZWQ6ICgoLi4uYXJnczogQXJyYXk8YW55PikgPT4gYW55KSB8IG51bGwgfCB1bmRlZmluZWQpIHtcclxuICAgIHRoaXMuX3NvY2tldFJlc3RhcnQob25SZXN0YXJ0ZWQpO1xyXG4gIH1cclxuXHJcbiAgX3NvY2tldFNodXRkb3duKHJlc3RhcnQ6IGJvb2xlYW4gfCBudWxsIHwgdW5kZWZpbmVkID0gZmFsc2UpIHtcclxuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGBzaHV0ZG93bl8ke3Y0KCl9YDtcclxuXHJcbiAgICBjb25zdCBtZXNzYWdlID0gX2NyZWF0ZU1lc3NhZ2UoXCJzaHV0ZG93bl9yZXF1ZXN0XCIsIHJlcXVlc3RJZCk7XHJcblxyXG4gICAgbWVzc2FnZS5jb250ZW50ID0ge1xyXG4gICAgICByZXN0YXJ0LFxyXG4gICAgfTtcclxuICAgIHRoaXMuc2hlbGxTb2NrZXQuc2VuZChuZXcgTWVzc2FnZShtZXNzYWdlKSk7XHJcbiAgfVxyXG5cclxuICBfc29ja2V0UmVzdGFydChcclxuICAgIG9uUmVzdGFydGVkOiAoKC4uLmFyZ3M6IEFycmF5PGFueT4pID0+IGFueSkgfCBudWxsIHwgdW5kZWZpbmVkXHJcbiAgKSB7XHJcbiAgICBpZiAodGhpcy5leGVjdXRpb25TdGF0ZSA9PT0gXCJyZXN0YXJ0aW5nXCIpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuc2V0RXhlY3V0aW9uU3RhdGUoXCJyZXN0YXJ0aW5nXCIpO1xyXG5cclxuICAgIHRoaXMuX3NvY2tldFNodXRkb3duKHRydWUpO1xyXG5cclxuICAgIHRoaXMuX2tpbGwoKTtcclxuXHJcbiAgICBjb25zdCB7IHNwYXduIH0gPSBsYXVuY2hTcGVjRnJvbUNvbm5lY3Rpb25JbmZvKFxyXG4gICAgICB0aGlzLmtlcm5lbFNwZWMsXHJcbiAgICAgIHRoaXMuY29ubmVjdGlvbixcclxuICAgICAgdGhpcy5jb25uZWN0aW9uRmlsZSxcclxuICAgICAgdGhpcy5vcHRpb25zXHJcbiAgICApO1xyXG4gICAgdGhpcy5rZXJuZWxQcm9jZXNzID0gc3Bhd247XHJcbiAgICB0aGlzLm1vbml0b3IoKCkgPT4ge1xyXG4gICAgICB0aGlzLl9leGVjdXRlU3RhcnR1cENvZGUoKTtcclxuXHJcbiAgICAgIGlmIChvblJlc3RhcnRlZCkge1xyXG4gICAgICAgIG9uUmVzdGFydGVkKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gb25SZXN1bHRzIGlzIGEgY2FsbGJhY2sgdGhhdCBtYXkgYmUgY2FsbGVkIG11bHRpcGxlIHRpbWVzXHJcbiAgLy8gYXMgcmVzdWx0cyBjb21lIGluIGZyb20gdGhlIGtlcm5lbFxyXG4gIGV4ZWN1dGUoY29kZTogc3RyaW5nLCBvblJlc3VsdHM6IFJlc3VsdHNDYWxsYmFjaykge1xyXG4gICAgbG9nKFwiWk1RS2VybmVsLmV4ZWN1dGU6XCIsIGNvZGUpO1xyXG4gICAgY29uc3QgcmVxdWVzdElkID0gYGV4ZWN1dGVfJHt2NCgpfWA7XHJcblxyXG4gICAgY29uc3QgbWVzc2FnZSA9IF9jcmVhdGVNZXNzYWdlKFwiZXhlY3V0ZV9yZXF1ZXN0XCIsIHJlcXVlc3RJZCk7XHJcblxyXG4gICAgbWVzc2FnZS5jb250ZW50ID0ge1xyXG4gICAgICBjb2RlLFxyXG4gICAgICBzaWxlbnQ6IGZhbHNlLFxyXG4gICAgICBzdG9yZV9oaXN0b3J5OiB0cnVlLFxyXG4gICAgICB1c2VyX2V4cHJlc3Npb25zOiB7fSxcclxuICAgICAgYWxsb3dfc3RkaW46IHRydWUsXHJcbiAgICB9O1xyXG4gICAgdGhpcy5leGVjdXRpb25DYWxsYmFja3NbcmVxdWVzdElkXSA9IG9uUmVzdWx0cztcclxuICAgIHRoaXMuc2hlbGxTb2NrZXQuc2VuZChuZXcgTWVzc2FnZShtZXNzYWdlKSk7XHJcbiAgfVxyXG5cclxuICBjb21wbGV0ZShjb2RlOiBzdHJpbmcsIG9uUmVzdWx0czogUmVzdWx0c0NhbGxiYWNrKSB7XHJcbiAgICBsb2coXCJaTVFLZXJuZWwuY29tcGxldGU6XCIsIGNvZGUpO1xyXG4gICAgY29uc3QgcmVxdWVzdElkID0gYGNvbXBsZXRlXyR7djQoKX1gO1xyXG5cclxuICAgIGNvbnN0IG1lc3NhZ2UgPSBfY3JlYXRlTWVzc2FnZShcImNvbXBsZXRlX3JlcXVlc3RcIiwgcmVxdWVzdElkKTtcclxuXHJcbiAgICBtZXNzYWdlLmNvbnRlbnQgPSB7XHJcbiAgICAgIGNvZGUsXHJcbiAgICAgIHRleHQ6IGNvZGUsXHJcbiAgICAgIGxpbmU6IGNvZGUsXHJcbiAgICAgIGN1cnNvcl9wb3M6IGpzX2lkeF90b19jaGFyX2lkeChjb2RlLmxlbmd0aCwgY29kZSksXHJcbiAgICB9O1xyXG4gICAgdGhpcy5leGVjdXRpb25DYWxsYmFja3NbcmVxdWVzdElkXSA9IG9uUmVzdWx0cztcclxuICAgIHRoaXMuc2hlbGxTb2NrZXQuc2VuZChuZXcgTWVzc2FnZShtZXNzYWdlKSk7XHJcbiAgfVxyXG5cclxuICBpbnNwZWN0KGNvZGU6IHN0cmluZywgY3Vyc29yUG9zOiBudW1iZXIsIG9uUmVzdWx0czogUmVzdWx0c0NhbGxiYWNrKSB7XHJcbiAgICBsb2coXCJaTVFLZXJuZWwuaW5zcGVjdDpcIiwgY29kZSwgY3Vyc29yUG9zKTtcclxuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGBpbnNwZWN0XyR7djQoKX1gO1xyXG5cclxuICAgIGNvbnN0IG1lc3NhZ2UgPSBfY3JlYXRlTWVzc2FnZShcImluc3BlY3RfcmVxdWVzdFwiLCByZXF1ZXN0SWQpO1xyXG5cclxuICAgIG1lc3NhZ2UuY29udGVudCA9IHtcclxuICAgICAgY29kZSxcclxuICAgICAgY3Vyc29yX3BvczogY3Vyc29yUG9zLFxyXG4gICAgICBkZXRhaWxfbGV2ZWw6IDAsXHJcbiAgICB9O1xyXG4gICAgdGhpcy5leGVjdXRpb25DYWxsYmFja3NbcmVxdWVzdElkXSA9IG9uUmVzdWx0cztcclxuICAgIHRoaXMuc2hlbGxTb2NrZXQuc2VuZChuZXcgTWVzc2FnZShtZXNzYWdlKSk7XHJcbiAgfVxyXG5cclxuICBpbnB1dFJlcGx5KGlucHV0OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGBpbnB1dF9yZXBseV8ke3Y0KCl9YDtcclxuXHJcbiAgICBjb25zdCBtZXNzYWdlID0gX2NyZWF0ZU1lc3NhZ2UoXCJpbnB1dF9yZXBseVwiLCByZXF1ZXN0SWQpO1xyXG5cclxuICAgIG1lc3NhZ2UuY29udGVudCA9IHtcclxuICAgICAgdmFsdWU6IGlucHV0LFxyXG4gICAgfTtcclxuICAgIHRoaXMuc3RkaW5Tb2NrZXQuc2VuZChuZXcgTWVzc2FnZShtZXNzYWdlKSk7XHJcbiAgfVxyXG5cclxuICBvblNoZWxsTWVzc2FnZShtZXNzYWdlOiBNZXNzYWdlKSB7XHJcbiAgICBsb2coXCJzaGVsbCBtZXNzYWdlOlwiLCBtZXNzYWdlKTtcclxuXHJcbiAgICBpZiAoIV9pc1ZhbGlkTWVzc2FnZShtZXNzYWdlKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyBtc2dfaWQgfSA9IG1lc3NhZ2UucGFyZW50X2hlYWRlcjtcclxuICAgIGxldCBjYWxsYmFjaztcclxuXHJcbiAgICBpZiAobXNnX2lkKSB7XHJcbiAgICAgIGNhbGxiYWNrID0gdGhpcy5leGVjdXRpb25DYWxsYmFja3NbbXNnX2lkXTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY2FsbGJhY2spIHtcclxuICAgICAgY2FsbGJhY2sobWVzc2FnZSwgXCJzaGVsbFwiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG9uU3RkaW5NZXNzYWdlKG1lc3NhZ2U6IE1lc3NhZ2UpIHtcclxuICAgIGxvZyhcInN0ZGluIG1lc3NhZ2U6XCIsIG1lc3NhZ2UpO1xyXG5cclxuICAgIGlmICghX2lzVmFsaWRNZXNzYWdlKG1lc3NhZ2UpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBpbnB1dF9yZXF1ZXN0IG1lc3NhZ2VzIGFyZSBhdHRyaWJ1dGFibGUgdG8gcGFydGljdWxhciBleGVjdXRpb24gcmVxdWVzdHMsXHJcbiAgICAvLyBhbmQgc2hvdWxkIHBhc3MgdGhyb3VnaCB0aGUgbWlkZGxld2FyZSBzdGFjayB0byBhbGxvdyBwbHVnaW5zIHRvIHNlZSB0aGVtXHJcbiAgICBjb25zdCB7IG1zZ19pZCB9ID0gbWVzc2FnZS5wYXJlbnRfaGVhZGVyO1xyXG4gICAgbGV0IGNhbGxiYWNrO1xyXG5cclxuICAgIGlmIChtc2dfaWQpIHtcclxuICAgICAgY2FsbGJhY2sgPSB0aGlzLmV4ZWN1dGlvbkNhbGxiYWNrc1ttc2dfaWRdO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChjYWxsYmFjaykge1xyXG4gICAgICBjYWxsYmFjayhtZXNzYWdlLCBcInN0ZGluXCIpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb25JT01lc3NhZ2UobWVzc2FnZTogTWVzc2FnZSkge1xyXG4gICAgbG9nKFwiSU8gbWVzc2FnZTpcIiwgbWVzc2FnZSk7XHJcblxyXG4gICAgaWYgKCFfaXNWYWxpZE1lc3NhZ2UobWVzc2FnZSkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHsgbXNnX3R5cGUgfSA9IG1lc3NhZ2UuaGVhZGVyO1xyXG5cclxuICAgIGlmIChtc2dfdHlwZSA9PT0gXCJzdGF0dXNcIikge1xyXG4gICAgICBjb25zdCBzdGF0dXMgPSBtZXNzYWdlLmNvbnRlbnQuZXhlY3V0aW9uX3N0YXRlO1xyXG4gICAgICB0aGlzLnNldEV4ZWN1dGlvblN0YXRlKHN0YXR1cyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyBtc2dfaWQgfSA9IG1lc3NhZ2UucGFyZW50X2hlYWRlcjtcclxuICAgIGxldCBjYWxsYmFjaztcclxuXHJcbiAgICBpZiAobXNnX2lkKSB7XHJcbiAgICAgIGNhbGxiYWNrID0gdGhpcy5leGVjdXRpb25DYWxsYmFja3NbbXNnX2lkXTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY2FsbGJhY2spIHtcclxuICAgICAgY2FsbGJhY2sobWVzc2FnZSwgXCJpb3B1YlwiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGRlc3Ryb3koKSB7XHJcbiAgICBsb2coXCJaTVFLZXJuZWw6IGRlc3Ryb3k6XCIsIHRoaXMpO1xyXG4gICAgdGhpcy5zaHV0ZG93bigpO1xyXG5cclxuICAgIHRoaXMuX2tpbGwoKTtcclxuXHJcbiAgICBmcy51bmxpbmtTeW5jKHRoaXMuY29ubmVjdGlvbkZpbGUpO1xyXG4gICAgdGhpcy5zaGVsbFNvY2tldC5jbG9zZSgpO1xyXG4gICAgdGhpcy5pb1NvY2tldC5jbG9zZSgpO1xyXG4gICAgdGhpcy5zdGRpblNvY2tldC5jbG9zZSgpO1xyXG4gICAgc3VwZXIuZGVzdHJveSgpO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gX2lzVmFsaWRNZXNzYWdlKG1lc3NhZ2U6IE1lc3NhZ2UpIHtcclxuICBpZiAoIW1lc3NhZ2UpIHtcclxuICAgIGxvZyhcIkludmFsaWQgbWVzc2FnZTogbnVsbFwiKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGlmICghbWVzc2FnZS5jb250ZW50KSB7XHJcbiAgICBsb2coXCJJbnZhbGlkIG1lc3NhZ2U6IE1pc3NpbmcgY29udGVudFwiKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGlmIChtZXNzYWdlLmNvbnRlbnQuZXhlY3V0aW9uX3N0YXRlID09PSBcInN0YXJ0aW5nXCIpIHtcclxuICAgIC8vIEtlcm5lbHMgc2VuZCBhIHN0YXJ0aW5nIHN0YXR1cyBtZXNzYWdlIHdpdGggYW4gZW1wdHkgcGFyZW50X2hlYWRlclxyXG4gICAgbG9nKFwiRHJvcHBlZCBzdGFydGluZyBzdGF0dXMgSU8gbWVzc2FnZVwiKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGlmICghbWVzc2FnZS5wYXJlbnRfaGVhZGVyKSB7XHJcbiAgICBsb2coXCJJbnZhbGlkIG1lc3NhZ2U6IE1pc3NpbmcgcGFyZW50X2hlYWRlclwiKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGlmICghbWVzc2FnZS5wYXJlbnRfaGVhZGVyLm1zZ19pZCkge1xyXG4gICAgbG9nKFwiSW52YWxpZCBtZXNzYWdlOiBNaXNzaW5nIHBhcmVudF9oZWFkZXIubXNnX2lkXCIpO1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgaWYgKCFtZXNzYWdlLnBhcmVudF9oZWFkZXIubXNnX3R5cGUpIHtcclxuICAgIGxvZyhcIkludmFsaWQgbWVzc2FnZTogTWlzc2luZyBwYXJlbnRfaGVhZGVyLm1zZ190eXBlXCIpO1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgaWYgKCFtZXNzYWdlLmhlYWRlcikge1xyXG4gICAgbG9nKFwiSW52YWxpZCBtZXNzYWdlOiBNaXNzaW5nIGhlYWRlclwiKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGlmICghbWVzc2FnZS5oZWFkZXIubXNnX2lkKSB7XHJcbiAgICBsb2coXCJJbnZhbGlkIG1lc3NhZ2U6IE1pc3NpbmcgaGVhZGVyLm1zZ19pZFwiKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIGlmICghbWVzc2FnZS5oZWFkZXIubXNnX3R5cGUpIHtcclxuICAgIGxvZyhcIkludmFsaWQgbWVzc2FnZTogTWlzc2luZyBoZWFkZXIubXNnX3R5cGVcIik7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuZnVuY3Rpb24gX2dldFVzZXJuYW1lKCkge1xyXG4gIHJldHVybiAoXHJcbiAgICBwcm9jZXNzLmVudi5MT0dOQU1FIHx8XHJcbiAgICBwcm9jZXNzLmVudi5VU0VSIHx8XHJcbiAgICBwcm9jZXNzLmVudi5MTkFNRSB8fFxyXG4gICAgcHJvY2Vzcy5lbnYuVVNFUk5BTUVcclxuICApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBfY3JlYXRlTWVzc2FnZShtc2dUeXBlOiBzdHJpbmcsIG1zZ0lkOiBzdHJpbmcgPSB2NCgpKSB7XHJcbiAgY29uc3QgbWVzc2FnZSA9IHtcclxuICAgIGhlYWRlcjoge1xyXG4gICAgICB1c2VybmFtZTogX2dldFVzZXJuYW1lKCksXHJcbiAgICAgIHNlc3Npb246IFwiMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwXCIsXHJcbiAgICAgIG1zZ190eXBlOiBtc2dUeXBlLFxyXG4gICAgICBtc2dfaWQ6IG1zZ0lkLFxyXG4gICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxyXG4gICAgICB2ZXJzaW9uOiBcIjUuMFwiLFxyXG4gICAgfSxcclxuICAgIG1ldGFkYXRhOiB7fSxcclxuICAgIHBhcmVudF9oZWFkZXI6IHt9LFxyXG4gICAgY29udGVudDoge30sXHJcbiAgfTtcclxuICByZXR1cm4gbWVzc2FnZTtcclxufVxyXG4iXX0=